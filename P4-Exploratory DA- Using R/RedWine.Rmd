---
title: "REDWINE ANALYSIS"
author: "MAHALAKSHMI"
output: 
  html_document: 
    keep_md: yes
---

```{r setup, include=FALSE,cache=FALSE}
knitr::opts_chunk$set(echo = TRUE,error=TRUE)
```

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
library(ggplot2)
library(gridExtra)
library(dplyr)
library(tidyr)
library(GGally)
```

###Loading the Dataset
Loading the dataset and observing the basic structure ,column names to get a basic understanding of the dataset.The dataset Chosen for exploratory data analysis wineQualityReds.csv.
It has 1599 wines listed with 11 attributes
```{r echo=FALSE, message=FALSE, warning=FALSE, LOADDATA}
rw <- read.csv('wineQualityReds.csv')
#View(rw)

```


#UNIVARIATE PLOT SECTION
The individual columns(attributes) are analysed using various geometric graphs to get some idea on thier distribution.
Checking the Distribution of the quality (response variable) of the listed wines.

```{r echo=FALSE, message=FALSE, warning=FALSE, BASICBARUNI}
ggplot(aes(x=quality),data =rw)+
  geom_bar()+
  xlim(2,9)
summary(rw$quality)
```
From the summary values and the plot it is observed that the values vary from 3-8 on the quality parameter hence the limits have been set accordingly

###UNIVARIATE PLOTS FOR PREDICTOR VARIABLES
citric.acid - from the table it can be seen that there are quite  lot of 0's and a entry with 1(probably an outlier)
```{r echo=FALSE, message=FALSE, warning=FALSE, UNI_PREDICTOR}
ggplot(aes(x=citric.acid),data=rw)+
  geom_histogram(binwidth = .025)+
  xlim(0,0.75)
summary(rw$citric.acid)
```
Plot for pHValue- shows a  near normal distribution

```{r echo=FALSE, message=FALSE, warning=FALSE, pH}
summary(rw$pH)
ggplot(aes(x=pH),data=rw)+
  geom_histogram(binwidth = 0.05)+
  xlim(2.5,4.5)+
  scale_x_continuous(breaks = seq(2.5,4.5,0.1))
 
```

###CHECKING OUT OTHER VARIABLES USING PLOTS
Below are the plots of multiple predictor variables(acidity,sulpahtes,alcohol,residual.sugar,chlorides,density,total SO2) in a single plot area using  grid.arrange
```{r echo=FALSE, message=FALSE, warning=FALSE, PLOTTING_PREDICTOR_VARIABLES }
plot_acidity<-ggplot(aes(x=volatile.acidity),data=rw)+
  geom_histogram()

plot_sulphates<-ggplot(aes(x=sulphates),data=rw)+
  geom_histogram(binwidth = 0.05)+xlim(0.25,2)

plot_alcohol<-ggplot(aes(x=alcohol),data=rw)+
  geom_histogram()

plot_sugar <-ggplot(aes(x=residual.sugar),data=rw)+
  geom_histogram()+
  xlim(0.9,quantile(rw$residual.sugar,0.95))

plot_chlorides <-ggplot(aes(x=chlorides),data=rw)+
  geom_histogram()+
  xlim(0,quantile(rw$chlorides,0.95))

plot_density <-ggplot(aes(x=density),data=rw)+
  geom_histogram()

plot_SO2<- ggplot(aes(x=total.sulfur.dioxide),data=rw)+
  geom_histogram()+
  xlim(0,quantile(rw$total.sulfur.dioxide,0.99))

grid.arrange(plot_acidity,plot_alcohol,plot_chlorides,plot_density,plot_sugar,plot_sulphates,plot_SO2)


```


#UNIVARIATE ANALYSIS:
The attribute names,structure of the data base is as below
```{r echo=FALSE, message=FALSE, warning=FALSE,STRUCTURE_AND_FEATURES}
#Key attributes
names(rw)
#Structure - to check continuous and categoricalvariables
str(rw)
# number of different wine samples available fo analysis
nrow(rw)
```
###OBJECTIVE 

The primary objective of the analysis is to find out how the quality of the wine varies w.r.t various properties

Response Variable - quality
Predictor Variables - acidity(2),citric acid,residual sugar,chlorides,sulphur dioxide(2),density,pH,sulphates,alcohol

All the Predictor Variables are continuous variables

Response variable quality is a categorical variable with factors 1 to 10 with 1 being the lowest  and 10 being the highest

OBSERVATION - there are no NA values for any of the variables

###Initial work on derived variables
From certain references we can calculate the total acidity based on the  sum of fixed acidity and volatile acidity
and also the Bound or fixed Sulphur dioxide from the difference of total and free Sulphur dioxide.
The usefulness of the derived variables will be explored further
```{r echo=FALSE, message=FALSE, warning=FALSE, DERIVED_VARIABLES}
rw<-transform(rw,total.acidity = fixed.acidity + volatile.acidity )
rw<-transform(rw,bound.sulfur.dioxide = total.sulfur.dioxide - free.sulfur.dioxide )
```

### Transformation of certain variables
Some of the variables like Total SO2,Sulphates,Chlorides and residual sugar seem to have a skewed distribution.By setting the limits .In the above graphs i have set the Limits

Based on the above we can scale some variables using   the transformations(log or SQRT) to get a near normal distribution.

```{r echo=FALSE, message=FALSE, warning=FALSE, LOG_TRANSFORMS}
plot_SO2<- ggplot(aes(x=total.sulfur.dioxide),data=rw)+
  geom_histogram()+scale_x_log10()

plot_chlorides <-ggplot(aes(x=chlorides),data=rw)+
  geom_histogram()+scale_x_log10()

plot_sulphates<-ggplot(aes(x=sulphates),data=rw)+
  geom_histogram()+scale_x_log10()

plot_sugar <-ggplot(aes(x=residual.sugar),data=rw)+
  geom_histogram()+scale_x_log10()

grid.arrange(plot_SO2,plot_chlorides,plot_sulphates,plot_sugar)
```
Setting the limits and the tranformation seem to help in normalising the distribution to adjust the skewness and we can check below if the same results in a better f-statistic

##BIVARIATE PLOT SECTION:
We can check the co relation between 2 variable using the Pearsons corelation and also thorugh graphs.
AS per certain internet resources, there are some co-relations between 
1.acidity fo the wine and pH value
2.Sulphar dioxide and quality

```{r echo=FALSE, message=FALSE, warning=FALSE, CO-RELATION_TESTS}
cor.test(rw$pH, rw$total.acidity)
# checking if only the pH is dependent on fixed acidity or if the volatile validity also has anything to do with it
cor.test(rw$pH, rw$fixed.acidity)

cor.test(rw$pH, rw$volatile.acidity)


```
From the above we can see that the fixed acidity has a higher corelation  impact on the pH value.We can map it out in a graph and explore this further

```{r echo=FALSE, message=FALSE, warning=FALSE, pH_VERSUS_ACIDITY }
p1<-ggplot(aes(x=pH,y=fixed.acidity),data=rw)+
  geom_point(alpha=1/5)+scale_y_log10()

p2<-ggplot(aes(x=pH,y=volatile.acidity),data=rw)+
  geom_point(alpha = 1/5)

grid.arrange(p1,p2)
```
From the above graph we can see a might inverse corelation between the fixed.Acidity and the pH value which is again not very strong as seen in the r value of -.68 ( just above the 0.5 threshold).
However the Volatile.acidity does not show any  corelation with the pHvalue

###Checking the relationship between quality and SO2 values
Based on some of the studies the proportion of free.sulphur.dioxide/bound.sulfur.dioxide determines the quality of the wine.

Reference:http://www.morethanorganic.com/sulphur-in-the-bottle

```{r echo=FALSE, message=FALSE, warning=FALSE, Derived_variable}
rw$prop_freebound_SO2 <- rw$free.sulfur.dioxide/rw$bound.sulfur.dioxide

#Plotting the same with the quality
ggplot(aes(x=quality,y=prop_freebound_SO2,group=quality),data=rw)+
  geom_boxplot(aes(color=quality))
```

Crosschecking the inference from the above graph
```{r echo=FALSE, message=FALSE, warning=FALSE, USING_DPLYR}
rw %>%group_by(quality) %>%
  summarise(median =median(prop_freebound_SO2),count =n())

```
It can be observed from the above result and the box plots that the propotion of free.Sulfur.dioxide has not impacted the quality rating of the experts

###Analysing Sulphur Dioxide content
Higher SO2 content becomes evident in taste and smell beyond 50 ppm.
Checking the summary statistic it is evident there are some outliers with values of 289 since the 3rd quartile value itself is 62 only.

```{r echo=FALSE, message=FALSE, warning=FALSE, SO2_CONTENT}
summary(rw$total.sulfur.dioxide)

with (subset(rw,rw$total.sulfur.dioxide <=150),cor.test(total.sulfur.dioxide,quality))


```
There seems to be a mild inverse corelation between the SO2 content and the quality
```{r echo=FALSE, message=FALSE, warning=FALSE, BOXPOLOT_SO2_QUALITY}
ggplot(aes(y=rw$total.sulfur.dioxide,x=rw$quality,group=quality),data=rw)+
  geom_boxplot(aes(color=rw$quality))+ylim(0,100)
table(rw$quality)
  
```
If we cut the outliers and consider only the middle 75% of the readings of quality
there seems to be a significant corelation between the SO2 content and quality rating

```{r echo=FALSE, message=FALSE, warning=FALSE, SUBSET_QUALITY_OUTLIERS}
rw_subset <- subset(rw,rw$quality<quantile(rw$quality,0.99) & rw$quality >quantile(rw$quality,0.01))

```
Plotting against the subsets

```{r echo=FALSE, message=FALSE, warning=FALSE, SUBSET_PLOTS}
ggplot(aes(y=total.sulfur.dioxide,x=quality,group=quality),data=rw_subset)+
  geom_boxplot(aes(color=quality))+ylim(0,100)
```

The subset shows a inverse relation between SO2 and Quality.


***OBSERVATION -
Based on the various wine resources the sulphates/sulphites value of a wine is the total SO2 value of the wine.However for this data set there exists a separate variable sulphates which is on the basis of pottasium sulphate content.However this can release SO2 gas.
The sulphates(Potassium metabisulphate) attribute is present in the form of gm/dm^3.Hence converting it to mg/dm3 to check if it has any significant impact on the quality when combined with the total.sulphur.dioxide

```{r echo=FALSE, message=FALSE, warning=FALSE, SULPHATES}
rw$sulphates_mg <-rw$sulphates *1000
cor.test((rw$sulphates+rw$total.sulfur.dioxide),rw$quality)
```

###Checking the corelation between Alcohol level and quality
```{r echo=FALSE, message=FALSE, warning=FALSE,  ALCOHOL_QUALITY}
ggplot(aes(x=quality ,
           y = alcohol,
           group=quality),data=rw)+
  geom_boxplot(aes(color=quality))
  
```
As per the above it is evident that there exists a positive corelation between the alcohol value and quality which is also confirmed by the pearson's r value of 0.476(near about 0.5)

### pH and Quality in a wine

As per expert research good quality red wines are normally within a pH range of 3.4
Here Iam trying to bucket the pH range into 2 levels to see if we can observe any significant relation


```{r echo=FALSE, message=FALSE, warning=FALSE, pH_quality}
summary(rw$pH)
rw$pH_bucket <-cut(rw$pH,c(2.7,3.4,4.01))
table(rw$pH_bucket)
rw_ph_qual <-rw %>%group_by(pH_bucket,quality)%>%
  summarise(Count= n())%>%arrange(quality)
library(tidyr)
rw_ph_qual_wide <-spread(rw_ph_qual,pH_bucket,Count)
names(rw_ph_qual_wide) <- c("quality","lowpH","highpH")
#Checking the proportion of highpH wines based on quality
rw_ph_qual_wide <-mutate(rw_ph_qual_wide,Proportion = highpH/(highpH+lowpH))
rw_ph_qual_wide$Proportion <- round(rw_ph_qual_wide$Proportion,digits = 2)
rw_ph_qual_wide
```
It can be seen from the above table that there exits  a marginal difference in the Proportion of highPH wines in each quality group with the lower rated wines having a slightly higher proportion of highpH wines as against the top rates ones.
This also verifies the fact that wines with a pH under 3.4 are supposed to be  of good quality 

###Relation between pH and density


```{r echo=FALSE, message=FALSE, warning=FALSE, pH_Density}
ggplot(aes(x=pH,y=density),data=rw)+geom_smooth()+
  scale_x_continuous(limits= c(3.0,3.6), breaks =  seq(3,3.6,0.1))
cor.test(rw$pH,rw$density)

```

### Citric Acid and Acidity
Since the citric acid is part of acidity we can check if there exists a direct corelation between the two
```{r echo=FALSE, message=FALSE, warning=FALSE,Citric_Acid_Fixed_acidity}
ggplot(aes(x=citric.acid,y = fixed.acidity),data=rw)+geom_point()+
  geom_smooth(stat= 'summary', fun.y = median, color="red" , lintype=5)+
  xlim(0,0.5)
```
The above shows a positive corelation between citric acid and fixed acidity.

#BI-VARIATE ANALYSIS
Some of the relationships explored in the above section are
*CitricAcid and Fixed acidity
*pH and Acidity
*Quality and SO2
*pH and density
*Alcohol and Quality

There seems to a be a  corelation between SO2 and the quality,Citric acid and acidity,pH and acidity and also seemingly mild relations between pH and density.
However there were certain instances like the proportion of Free So2 versus quality which yielded no observable clear corelations.

some of the strongest relations are observed between pH and fixed acidity,Alcohol and quality,citric acid and fixed acidity


#MULTIVARIATE PLOT SECTION:

From the above analysis we can see that there exists a relation between citric acid value and fixed acidity and the same is analysed with quality

```{r echo=FALSE, message=FALSE, warning=FALSE, CITRIC_ACIDITY_QUALITY-1}
rw$quality_factor <- factor(rw$quality)
ggplot(aes(y=rw$fixed.acidity,x=rw$citric.acid),data=rw)+
  geom_jitter(aes(color= quality_factor))+
  scale_color_brewer(type='qual')+
  geom_vline(xintercept = mean(rw$citric.acid))+
   xlim(0,0.75)
  
```


This shows that as the citric acid content increases there is a percieved better quality in the wine.
Also the slight increasing trend show the positive corealtion between citric acid and fixed acidity

```{r echo=FALSE, message=FALSE, warning=FALSE, CITRIC_ACIDITY_QUALITY-2}
 rw %>% group_by(quality) %>%
  summarise(Median = median(citric.acid),count = n())

```
The observation from the graph is again reinstated showing a better perceived qualtiy with a positive corelation with citric acid

###EXAMININING THE ACIDITY ,  QUALITY AND DENSITY

```{r echo=FALSE, message=FALSE, warning=FALSE, ACIDITY_QUALITY_DENSITY}
rw$quality_factor <- factor(rw$quality)
ggplot(aes(x=rw$fixed.acidity, y=rw$density),data=rw)+
geom_jitter(aes(color=quality_factor))+
  xlim(5,quantile(rw$fixed.acidity,0.99))+
  ylim(0.99,quantile(rw$density,0.99))+
 scale_color_brewer(type = 'div')+
  geom_smooth(stat="summary" , fun.y = median, color="maroon")
```


Inference:
Fixed acidity has a positive coreltion with the density but we can observe that the higher quality wines have a lesser density with more blue dots below the median line and the brownish dots above
### Checking the realtionship between density and quality using tables

```{r echo=FALSE, message=FALSE, warning=FALSE, TABLES_DENSITY_QUALITY}
rw %>% group_by(quality) %>% summarise(Median_density = median(density),Count = n())

```
If we look at the same using the mean function from the tables, the relationship is not so evident may be because the median and the mean are taken over larged grouped samples and the nuances are evened out.
### SCATTER MATRIX TO CHECK THE INTERACTION AMONG THE ATTRIBUTES
Trying to plot a scatter matrix to arrive at the corelation among the attributes

```{r echo=FALSE, message=FALSE, warning=FALSE, SCATTER_MATRIX}
names(rw)
#Trying to subset the significant columns only
rw_col_subset <- rw[,c(2:13)]
ggpairs(rw_col_subset,
        columnLabels =c("F.Acidity","V.Acidity","Citric","Sugar","Chlorides","Free SO2","Total SO2","Density","pH","Sulphates","Alcohol","Quality"))
        
```

From the above graphs we can see the relation between 
Citric.acid -volatile.acidity
Citric.acid -fixed acidity
Citric.acid -pH
fixed.acidity -pH 
fixed.acidity-density
alcohol-density-quality

###Checking relation between alcohol Density and quality
```{r echo=FALSE, message=FALSE, warning=FALSE, ALCOHOL_DENSITY_QUALITY}
ggplot(aes(x=density,y=alcohol),data=rw)+
 
  geom_jitter(aes(color=quality_factor),stat='summary',fun.y=mean)+
  scale_color_brewer(type = 'div')+geom_hline(yintercept = mean(rw$alcohol))
  

```
The above graph shows the inverse corelation between alcohol and density and also the positive corelation between alcohol content and quality With higher quality wines occupying the top of the mean line.

## BUILDING  LINEAR MODEL
Using the lm command to fit a linear model to the data

```{r echo=FALSE, message=FALSE, warning=FALSE, LM}
#Using the R column subset with the attributes provided and ignoring the derived attributes
#Chossing all attributes

all_model <-lm(quality ~ fixed.acidity+volatile.acidity+citric.acid+
              residual.sugar+chlorides+free.sulfur.dioxide+total.sulfur.dioxide+density+pH+sulphates+alcohol,data = rw)

#Choosing only certain attributes
few_model <-lm(quality ~ volatile.acidity+citric.acid+
              chlorides+log(total.sulfur.dioxide)+pH+log(sulphates)+alcohol,
              data = rw_col_subset)

summary(few_model)
summary(all_model)
```
## TEST AND TRAINING DATA
The Training set :Test Set has been split at 90:10 since the dataset is relatively small

```{r echo=FALSE, message=FALSE, warning=FALSE, TEST_TRAINING}
#Since the data set is small having 90% for the training
set.seed(100)
rw_train <- rw_col_subset[sample(1440), ] #approximately 90%
rw_test <- setdiff(rw_col_subset,rw_train) #approximately 10%

#Choosing only certain attributes
few_model <-lm(quality ~ volatile.acidity+citric.acid+
              chlorides+log(total.sulfur.dioxide)+pH+log(sulphates)+alcohol,
              data = rw_train)

summary(few_model)
summary(all_model)


```
## PREDICTION using test data

```{r echo=FALSE, message=FALSE, warning=FALSE, PREDICTION}
chosen <- rw_test[sample(nrow(rw_test),1),]
test_wine <- data.frame(volatile.acidity = chosen$volatile.acidity,
                        citric.acid = chosen$citric.acid,
                        chlorides = chosen$chlorides,
                        total.sulfur.dioxide = chosen$total.sulfur.dioxide,
                        pH= chosen$pH,
                        sulphates = chosen$sulphates,
                        alcohol = chosen$alcohol)
modelEstimate <- predict(few_model,newdata = test_wine,
                         interval = "prediction",level =0.95)
Estimated_value <-round(modelEstimate[1,1])
sprintf("Estimator Output: %s",Estimated_value)
sprintf("Actual Output: %s",chosen$quality)


```
# MULTI-VARIATE ANALYSIS
 The analysis are inferences from each of the plot segment is mentioned under the plot.Also a Linear model has been built based on the data provided.
There have been really surprising corelations that can be observed from the plots and from the significance indicated in the model.The density,residula sugar  and fixed acidity do not seem to play an important role in determinig the quality however the exploratory data did show some relation

The model was initially built using all the variables and was further tuned to consider only the significant variables.
Limitations:The training :test ratio for building the model was 90%:10%  since the number of data points were limited.Hence there is a possibility of overfitting in the data

#FINAL PLOTS AND SUMMARY
Below are some of the final plots chosen which provide significant relationship among the variables.

###Plot One
SO2 and Quality
```{r echo=FALSE, message=FALSE, warning=FALSE, Plot1}
ggplot(aes(y=total.sulfur.dioxide,x=quality,group=quality),data=rw_subset)+
  geom_boxplot(aes(fill=quality,colour="#5566FF"))+ylim(10,100)+
  ggtitle("Total Sulphur Dioxide versus Quality")+
  xlab('Quality')+
  ylab('Total Sulphur Dioxide')
  
```
###Description 1:
The above plot shows the clear realtion between Total SO2 Content(y axis) and Quality(X axis).The higher the SO2 content the lower is the rated quality.
So2 is used a  necessary preservative however at higher levels it affects the taste and emits a not so good smell bringing down the  quality

###Plot Two
Acidity and citric Acid and Quality
```{r echo=FALSE, message=FALSE, warning=FALSE, Plot2}
ggplot(aes(y=rw$fixed.acidity,x=rw$citric.acid),data=rw)+
  geom_jitter(aes(color=quality_factor))+
  scale_color_brewer(type='qual')+
  geom_vline(xintercept = mean(rw$citric.acid))+
  ggtitle("Quality versus  Citric acid and Acidity")+
  xlim(0,0.75)+
  xlab("Citric acid ")+
  ylab("Fixed Acidity")


```

###Description 2:
Citric acid(X-axis) has a positive corelation with fixed acidity(y-axis) since it is a part of acidity value.
Just a casual observation will lead to make us believe that the better quality wines have a higher fixed acidity ,but this is mostly because of a higher citric acid presence with most of the high rated wines having a citric acid content of over 0.27 


###Plot 3
Alcohol -Density-Quality
```{r echo=FALSE, message=FALSE, warning=FALSE, Plot3}
ggplot(aes(x=density,y=alcohol),data=rw)+
   geom_jitter(aes(color=quality_factor),stat='summary',fun.y=median)+
  scale_color_brewer(type = 'div')+
  geom_hline(yintercept = mean(rw$alcohol))+
  ggtitle("Density versus Alcohol versus Quality")+
  xlab("Density")+
  ylab("Alcohol")

```

###Description 3:
The above plot shows the realtionship between alcohol(y axis) ,density(x axix) and quality(3rd dimension in coloured points)
We can  see a inverse relation between alcohol and density and also a positive corelation between higher quality and higher alcohol content can be observed which indicates that most of the highly rated alcohols had a higher alcohol content.

#REFLECTION
The Data set was fairly small with a limited set of attributes.
The dataset is quite clean which was easy in getting started with the analysis.

Surprise points:
There were some variables(citric acid and acidity) for which the  corelation number did not reveal much but plotting them in a graph could bring in the relationship.

There were some variables(acidity/density) which seemed to have a relationship to the quality but were considered insignificant in the linear model

Some struggles/Limitations:
-The data set was fairly small and also the samples for quality rating of 3 and 8 were too less so the presence in the point graphs could not be felt to make appropriate conclusions and more dependency was on quality grade of 4-7 which is mostly hovering around the mean quality.

- On the multivariate plots,plotting the variable was ok but deriving meaningful inference was a bit difficult

- Also felt the lack of domain knowledge/chemistry to my disadvantage

Future Possible explorations:
New features can be formed based on the realtionship and interaction between the variables like(citric acid and acidity) or pH and acidity or sulpahtes and SO2 -how each of the variable is dependent upon the other and the rate a which it is affected.
This would in turn help fine tuning the linear model for a better fit to the data.


